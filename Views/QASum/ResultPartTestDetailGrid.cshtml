<!doctype html>
<html>
<head>
    <link href="~/Content/fusiongrid.css" rel="stylesheet" />
    <script src="~/Scripts/fusiongrid.js"></script>
    <script src="~/Scripts/jquery.min.js"></script>
</head>

<body>
    <br />
    <!-- === SEARCH FORM === -->
    <form class="row g-3" action="@Url.Action("", "ResultPartTestDetailGrid")" method="get">

        <div class="col-auto">
            <input type="date" class="form-control" name="startDate" value="@ViewBag.StartDate" />
        </div>

        <div class="col-auto">
            <label style="margin-top:6px"> : </label>
        </div>

        <div class="col-auto">
            <input type="date" class="form-control" name="endDate" value="@ViewBag.EndDate" />
        </div>

        <div class="col-auto">
            <input class="form-control" placeholder="Task No"
                   value="@ViewBag.TaskNo" type="text" name="TaskNo">
        </div>

        <div class="col-auto">
            <input class="form-control" placeholder="PartTests No"
                   value="@ViewBag.PartTestsNo" type="text" name="PartTestsNo">
        </div>

        <div class="col-md-auto">
            <button type="submit" class="btn btn-dark mb-lg-1">OK</button>
        </div>
    </form>

    <div class="mt-3"></div>

    <!-- === TOOLBAR === -->
    <div>
        <input id="search-text" placeholder="Search here" />
        <button id="search-btn">Search</button>
        <button id="reset-btn">Reset</button>
        <button id="csv-btn">CSV</button>
        <button id="xls-btn">Excel</button>
    </div>

    <div class="mt-3"></div>

    <!-- === GRID === -->
    <div id="grid-container" style="width: 100%; height: 750px;"></div>

    <script>

        // Schema
        var schema = [
            { name: 'part' },
            { name: 'serial' },
            { name: 'task' },
            { name: 'test_part' },
            { name: 'part_desc' },
            { name: 'test_result' },
            { name: 'test_fault' },
            { name: 'test_status' },
            { name: 'run_number' },
            { name: 'station' },
            { name: 'date_tested' }
        ];

        // === AJAX ===
        $.ajax({
            url: '@Url.Action("", "GetDataTestR")',
            data: {
                startDate: "@ViewBag.StartDate",
                endDate: "@ViewBag.EndDate",
                TaskNo: "@ViewBag.TaskNo",
                PartTestsNo: "@ViewBag.PartTestsNo",
                Status: "@ViewBag.Status"
            },
            method: "GET",

            success: function (data) {

                console.log("RAW DATA:", data);

                // --- FIX: Data already JSON ---
                let obj;

                if (typeof data === "string") {
                    if (data.trim() === "") {
                        obj = [];
                    } else {
                        obj = JSON.parse(data);
                    }
                } else {
                    obj = data || [];
                }

                var dataStore = new FusionGrid.DataStore();
                var dataTable = dataStore.createDataTable(obj, schema, { enableIndex: false });

                var grid = new FusionGrid(
                    document.getElementById('grid-container'),
                    dataTable,
                    {
                        pagination: {
                            enable: true,
                            showPages: { enable: true, showTotal: true, userInput: true },
                            showRecordCount: true,
                            pageSize: { default: 30, options: [10, 20, 30, 50] },
                            showJumpToEndButtons: true
                        },
                        defaultColumnOptions: {
                            searchable: true,
                            sortable: true,
                            filter: true
                        }
                    }
                );

                grid.render();

                // Export
                document.getElementById("xls-btn").addEventListener("click", () => {
                    grid.export({ format: "xlsx", mode: "full", name: "export_xls" });
                });

                document.getElementById("csv-btn").addEventListener("click", () => {
                    grid.export({ format: "csv", mode: "full", name: "export_csv" });
                });

                // Search
                document.getElementById("search-btn").addEventListener("click", () => {
                    grid.search(document.getElementById("search-text").value);
                });

                // Reset Search
                document.getElementById("reset-btn").addEventListener("click", () => {
                    grid.resetSearch();
                });
            }
        });
    </script>

</body>
</html>
